<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenBank Metadata Extractor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: fadeInUp 0.8s ease;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .file-upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            position: relative; /* <-- add this line */
        }

        .file-upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .file-upload-area.dragging {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .file-upload-area.green {
            background: #f0fff4;
            border-color: #28a745;
        }

        .file-upload-area.green:hover {
            background: #e8ffe8;
        }

        .file-upload-area.yellow {
            background: #fffef0;
            border-color: #ffc107;
        }

        .file-upload-area.yellow:hover {
            background: #fffce0;
        }

        .file-upload-area input[type="file"] {
            position: absolute;
            inset: 0;   /* top/right/bottom/left: 0 */
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-icon.green {
            color: #28a745;
        }

        .upload-icon.yellow {
            color: #ffc107;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: #f5f5f5;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }

        .file-item.genbank {
            background: #f0fff4;
            border-left: 4px solid #28a745;
        }

        .file-item.local {
            background: #fffef0;
            border-left: 4px solid #ffc107;
        }

        .file-item button {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-right: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 15px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .status-message {
            color: #555;
            margin-bottom: 10px;
        }

        .log-area {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 15px;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .data-table {
            width: 100%;
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th {
            background: #f8f9ff;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #667eea;
            white-space: nowrap;
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #0dcaf0;
            color: #055160;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card.blue {
            background: #f8f9ff;
        }

        .stat-card.green {
            background: #f0fff4;
        }

        .stat-card.yellow {
            background: #fffef0;
        }

        .stat-card.red {
            background: #fff0f0;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 15px 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧬 GenBank Metadata Extractor</h1>
            <p>Extract comprehensive metadata from FASTA sequences using GenBank records</p>
        </div>

        <div class="main-card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'enhanced')">Enhanced Processing</button>
                <button class="tab" onclick="switchTab(event, 'quick')">Quick Parse</button>
                <button class="tab" onclick="switchTab(event, 'instructions')">Instructions</button>
            </div>

            <!-- Enhanced Processing Tab -->
            <div id="enhanced" class="tab-content active">
                <div class="alert alert-info">
                    <strong>✨ Enhanced Mode:</strong> Upload your FASTA files along with GenBank records (.gb files) downloaded from NCBI. 
                    Also supports local unpublished GenBank files for sequences not yet in the public database.
                </div>

                <div class="section">
                    <h2>📁 Step 1: Upload FASTA Files</h2>
                    <div class="file-upload-area" id="uploadArea">
                        <div class="upload-icon">📤</div>
                        <p><strong>Drop FASTA files here or click to browse</strong></p>
                        <p style="color: #888; margin-top: 10px;">Supported formats: .fasta, .fa, .txt</p>
                        <input type="file" id="fileInput" multiple accept=".fasta,.fa,.txt">
                    </div>
                    <div class="file-list" id="fileList"></div>
                </div>

                <div class="section">
                    <h2>📗 Step 2: Upload GenBank Records (Downloaded from NCBI)</h2>
                    <div class="alert alert-success">
                        <strong>How to get .gb files:</strong> Search your accession numbers on <a href="https://www.ncbi.nlm.nih.gov/nuccore/" target="_blank">NCBI Nucleotide</a>, 
                        select "GenBank (full)" from the dropdown, then click "Send to: File" to download.
                    </div>
                    <div class="file-upload-area green" id="genbankArea">
                        <div class="upload-icon green">📑</div>
                        <p><strong>Drop .gb files here or click to browse</strong></p>
                        <p style="color: #888; margin-top: 10px;">Files downloaded from NCBI</p>
                        <input type="file" id="genbankInput" multiple accept=".gb,.gbk,.txt">
                    </div>
                    <div class="file-list" id="genbankList"></div>
                </div>

                <div class="section">
                    <h2>📙 Step 3: Upload Local/Unpublished GenBank Files (Optional)</h2>
                    <div class="alert alert-warning">
                        <strong>Optional:</strong> Add GenBank flatfiles for unpublished sequences. These will be checked first before using the NCBI downloads.
                    </div>
                    <div class="file-upload-area yellow" id="localArea">
                        <div class="upload-icon yellow">📂</div>
                        <p><strong>Drop local GenBank files here</strong></p>
                        <p style="color: #888; margin-top: 10px;">For unpublished sequences</p>
                        <input type="file" id="localInput" multiple accept=".gb,.gbk,.txt">
                    </div>
                    <div class="file-list" id="localList"></div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-primary" id="processBtn" disabled onclick="processEnhanced()">
                        Process Files
                    </button>
                    <button class="btn-secondary" onclick="clearAll()">
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Quick Parse Tab -->
            <div id="quick" class="tab-content">
                <div class="alert alert-info">
                    <strong>⚡ Quick Mode:</strong> Parse sequence IDs without GenBank data. Extracts species names and basic metadata from the FASTA headers.
                </div>

                <div class="section">
                    <h2>Upload FASTA Files</h2>
                    <div class="file-upload-area" id="quickArea">
                        <div class="upload-icon">⚡</div>
                        <p><strong>Drop FASTA files for quick parsing</strong></p>
                        <input type="file" id="quickInput" multiple accept=".fasta,.fa,.txt">
                    </div>
                    <div class="file-list" id="quickList"></div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn-primary" id="quickBtn" disabled onclick="processQuick()">
                        Quick Parse
                    </button>
                </div>
            </div>

            <!-- Instructions Tab -->
            <div id="instructions" class="tab-content">
                <h2>📖 How to Use This Tool</h2>
                
                <div class="section">
                    <h3>🌟 Enhanced Processing (Recommended)</h3>
                    <ol style="line-height: 1.8;">
                        <li><strong>Upload FASTA files</strong> - Your sequence files</li>
                        <li><strong>Get GenBank records:</strong>
                            <ul style="margin: 10px 0 10px 20px;">
                                <li>Copy accession numbers from your FASTA (e.g., MN206892.1)</li>
                                <li>Go to <a href="https://www.ncbi.nlm.nih.gov/nuccore/" target="_blank">NCBI Nucleotide</a></li>
                                <li>Paste accessions in search box (can search multiple at once)</li>
                                <li>Select "GenBank (full)" from the Display dropdown</li>
                                <li>Click "Send to" → "File" → "Create File"</li>
                                <li>Upload the downloaded .gb file(s) here</li>
                            </ul>
                        </li>
                        <li><strong>Add local files</strong> (optional) - For unpublished sequences</li>
                        <li><strong>Click Process</strong> - Get complete metadata extraction</li>
                    </ol>
                </div>

                <div class="section">
                    <h3>⚡ Quick Parse Mode</h3>
                    <p>For rapid processing without GenBank lookups. Extracts:</p>
                    <ul style="margin: 10px 0 10px 20px;">
                        <li>Species names from IDs (e.g., "G_subdryophilus" → "Gymnopilus subdryophilus")</li>
                        <li>Type specimen indicators</li>
                        <li>Collection numbers</li>
                        <li>Basic metadata patterns</li>
                    </ul>
                </div>

                <div class="section">
                    <h3>📊 Output Files</h3>
                    <p>The tool generates CSV and JSON files containing:</p>
                    <div class="code-block">
Fasta ID              - Original sequence identifier
Species Name          - Scientific name
GenBank Accession     - NCBI accession number  
Location              - Collection location details
Type Status           - Holotype, Paratype, etc.
Collection Info       - Voucher/specimen data
Collection Date       - When collected
Collected By          - Collector name
Isolation Source      - Host/substrate
Reference             - Publication citation
Bibliography          - Full citation
Notes                 - Additional information
                    </div>
                </div>

                <div class="section">
                    <h3>💡 Tips</h3>
                    <ul style="line-height: 1.8;">
                        <li>You can download multiple GenBank records at once from NCBI</li>
                        <li>Local GenBank files are checked first, then NCBI downloads</li>
                        <li>The tool preserves the original FASTA sequence order</li>
                        <li>Works offline once GenBank files are uploaded</li>
                    </ul>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <h2>⚙️ Processing...</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="status-message" id="statusMessage">Initializing...</div>
                <div class="log-area" id="logArea"></div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <h2>📊 Results</h2>
                
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-value" id="statTotal">0</div>
                        <div>Total Sequences</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-value" id="statGenBank" style="color: #28a745;">0</div>
                        <div>With GenBank Data</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-value" id="statLocal" style="color: #ffc107;">0</div>
                        <div>From Local Files</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-value" id="statType" style="color: #dc3545;">0</div>
                        <div>Type Specimens</div>
                    </div>
                </div>
                
                <h3>Data Preview</h3>
                <div class="data-table" id="dataPreview"></div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-primary" onclick="downloadCSV()">
                        📊 Download CSV
                    </button>
                    <button class="btn-primary" onclick="downloadJSON()">
                        📋 Download JSON
                    </button>
                    <button class="btn-secondary" onclick="clearAll()">
                        🔄 Process New Files
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let fastaFiles = [];
        let genbankFiles = [];
        let localFiles = [];
        let quickFiles = [];
        let currentResults = [];
        let currentFileName = '';
        let localRecords = {};
        let ncbiRecords = {};

        // Initialize event listeners
        ['dragenter','dragover','dragleave','drop'].forEach(type => {
            window.addEventListener(type, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });
        
        function initializeEventListeners() {
            // Enhanced mode uploads
            setupFileUpload('uploadArea', 'fileInput', (files) => {
                fastaFiles = Array.from(files).filter(f => f.name.match(/\.(fasta|fa|txt)$/i));
                updateFileList('fileList', fastaFiles, 'fasta');
                checkProcessButton();
            });

            setupFileUpload('genbankArea', 'genbankInput', (files) => {
                genbankFiles = Array.from(files).filter(f => f.name.match(/\.(gb|gbk|txt)$/i));
                updateFileList('genbankList', genbankFiles, 'genbank');
            });

            setupFileUpload('localArea', 'localInput', (files) => {
                localFiles = Array.from(files).filter(f => f.name.match(/\.(gb|gbk|txt)$/i));
                updateFileList('localList', localFiles, 'local');
            });

            // Quick mode upload
            setupFileUpload('quickArea', 'quickInput', (files) => {
                quickFiles = Array.from(files).filter(f => f.name.match(/\.(fasta|fa|txt)$/i));
                updateFileList('quickList', quickFiles, 'fasta');
                document.getElementById('quickBtn').disabled = quickFiles.length === 0;
            });
        }

        function setupFileUpload(areaId, inputId, callback) {
            const area = document.getElementById(areaId);
            const input = document.getElementById(inputId);

            area.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => callback(e.target.files));

            // Drag and drop
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy';
                area.classList.add('dragging');
            });

            area.addEventListener('dragleave', () => {
                area.classList.remove('dragging');
            });

            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragging');
                callback(e.dataTransfer.files);
            });
        }

        function updateFileList(listId, files, type) {
            const list = document.getElementById(listId);
            list.innerHTML = '';

            files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = `file-item ${type}`;
                
                let icon = '📄';
                if (type === 'genbank') icon = '📗';
                if (type === 'local') icon = '📙';
                
                item.innerHTML = `
                    <span>${icon} ${file.name} (${formatFileSize(file.size)})</span>
                    <button onclick="removeFile('${type}', ${index})">Remove</button>
                `;
                list.appendChild(item);
            });
        }

        function removeFile(type, index) {
            switch(type) {
                case 'fasta':
                    fastaFiles.splice(index, 1);
                    updateFileList('fileList', fastaFiles, 'fasta');
                    checkProcessButton();
                    break;
                case 'genbank':
                    genbankFiles.splice(index, 1);
                    updateFileList('genbankList', genbankFiles, 'genbank');
                    break;
                case 'local':
                    localFiles.splice(index, 1);
                    updateFileList('localList', localFiles, 'local');
                    break;
                case 'quick':
                    quickFiles.splice(index, 1);
                    updateFileList('quickList', quickFiles, 'fasta');
                    document.getElementById('quickBtn').disabled = quickFiles.length === 0;
                    break;
            }
        }

        function checkProcessButton() {
            document.getElementById('processBtn').disabled = fastaFiles.length === 0;
        }

        function switchTab(evt, tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function processEnhanced() {
            showProgress();
            log('Starting enhanced processing...');
            
            localRecords = {};
            ncbiRecords = {};
            currentResults = [];

            // Load local GenBank files first
            if (localFiles.length > 0) {
                log(`Loading ${localFiles.length} local GenBank file(s)...`);
                for (const file of localFiles) {
                    await loadGenBankFile(file, localRecords, 'local');
                }
                log(`Loaded ${Object.keys(localRecords).length} local records`);
            }

            // Load NCBI GenBank files
            if (genbankFiles.length > 0) {
                log(`Loading ${genbankFiles.length} NCBI GenBank file(s)...`);
                for (const file of genbankFiles) {
                    await loadGenBankFile(file, ncbiRecords, 'ncbi');
                }
                log(`Loaded ${Object.keys(ncbiRecords).length} NCBI records`);
            }

            // Process FASTA files
            let totalSequences = 0;
            let processedSequences = 0;

            // Count total
            for (const file of fastaFiles) {
                const content = await readFile(file);
                const sequences = parseFasta(content);
                totalSequences += sequences.length;
            }

            // Process each FASTA file
            for (const file of fastaFiles) {
                currentFileName = file.name;
                log(`Processing ${file.name}...`);
                
                const content = await readFile(file);
                const sequences = parseFasta(content);

                for (const seq of sequences) {
                    processedSequences++;
                    updateProgress(processedSequences, totalSequences, `Processing ${seq.id}...`);

                    // Try to find metadata in order: local → NCBI → parse ID
                    let metadata = searchRecords(seq.id, localRecords, 'local');
                    
                    if (!metadata) {
                        metadata = searchRecords(seq.id, ncbiRecords, 'NCBI');
                    }
                    
                    if (!metadata) {
                        log(`No GenBank record found for ${seq.id}, parsing ID...`);
                        metadata = parseSequenceId(seq.id);
                    }

                    currentResults.push(metadata);
                }
            }

            log(`Processing complete! Extracted metadata for ${currentResults.length} sequences`);
            showResults();
        }

        async function processQuick() {
            showProgress();
            currentResults = [];

            for (const file of quickFiles) {
                currentFileName = file.name;
                updateStatus(`Quick parsing ${file.name}...`);
                
                const content = await readFile(file);
                const sequences = parseFasta(content);

                sequences.forEach((seq, index) => {
                    updateProgress(index + 1, sequences.length, `Parsing ${seq.id}...`);
                    currentResults.push(parseSequenceId(seq.id));
                });
            }

            showResults();
        }

        async function loadGenBankFile(file, storage, source) {
            const content = await readFile(file);
            const records = content.split(/\/\/\s*\n/);
            
            for (const record of records) {
                if (!record.trim()) continue;
                
                const metadata = parseGenBankRecord(record);
                if (metadata.genbank_accession) {
                    // Store by multiple keys for flexible matching
                    storage[metadata.genbank_accession] = metadata;
                    storage[metadata.genbank_accession.split('.')[0]] = metadata;
                    
                    // Also store by voucher if available
                    if (metadata.collection_info) {
                        const voucher = metadata.collection_info.replace(/\s+/g, '');
                        storage[voucher] = metadata;
                    }
                    
                    log(`Loaded ${source} record: ${metadata.genbank_accession}`);
                }
            }
        }

        function searchRecords(id, records, source) {
            // Try various matching strategies
            const searchKeys = [
                id,
                id.split('.')[0],
                id.replace('-', ''),
                id.replace('_', ''),
                id.toUpperCase()
            ];

            for (const key of searchKeys) {
                if (records[key]) {
                    log(`Found in ${source}: ${id} → ${records[key].genbank_accession}`);
                    const metadata = {...records[key]};
                    metadata.fasta_id = id; // Preserve original FASTA ID
                    metadata.notes = `Source: ${source}`;
                    return metadata;
                }
            }
            return null;
        }

        function parseGenBankRecord(record) {
            const metadata = {
                fasta_id: '',
                species_name: 'Unknown',
                collection_info: '',
                type_status: '',
                genbank_accession: '',
                location: '',
                location_simplified: '',
                isolation_source: '',
                collection_date: '',
                collected_by: '',
                inat_mo_number: '',
                notes: '',
                reference: '',
                bibliography: ''
            };

            // Parse ACCESSION
            const accessionMatch = record.match(/ACCESSION\s+(\S+)/);
            if (accessionMatch) {
                metadata.genbank_accession = accessionMatch[1];
                metadata.fasta_id = accessionMatch[1];
            }

            // Parse ORGANISM
            const organismMatch = record.match(/ORGANISM\s+(.+?)(?:\n|$)/);
            if (organismMatch) {
                const organism = organismMatch[1].trim();
                const parts = organism.split(/\s+/);
                if (parts.length >= 2) {
                    metadata.species_name = `${parts[0]} ${parts[1]}`;
                } else {
                    metadata.species_name = organism;
                }
            }

            // Parse features
            const features = record.match(/FEATURES[^]*?(?=^[A-Z]|\n\/\/|$)/m);
            if (features) {
                // Location
                const locationMatch = features[0].match(/\/geo_loc_name="([^"]+)"/);
                if (locationMatch) {
                    metadata.location = locationMatch[1];
                    metadata.location_simplified = simplifyLocation(locationMatch[1]);
                } else {
                    const countryMatch = features[0].match(/\/country="([^"]+)"/);
                    if (countryMatch) {
                        metadata.location = countryMatch[1];
                        metadata.location_simplified = simplifyLocation(countryMatch[1]);
                    }
                }

                // Voucher
                const voucherMatch = features[0].match(/\/specimen_voucher="([^"]+)"/);
                if (voucherMatch) {
                    metadata.collection_info = voucherMatch[1];
                }

                // Collection date
                const dateMatch = features[0].match(/\/collection_date="([^"]+)"/);
                if (dateMatch) {
                    metadata.collection_date = dateMatch[1];
                }

                // Isolation source
                const isolationMatch = features[0].match(/\/isolation_source="([^"]+)"/);
                if (isolationMatch) {
                    metadata.isolation_source = isolationMatch[1];
                } else {
                    const hostMatch = features[0].match(/\/host="([^"]+)"/);
                    if (hostMatch) {
                        metadata.isolation_source = `Host: ${hostMatch[1]}`;
                    }
                }

                // Collector
                const collectorMatch = features[0].match(/\/collected_by="([^"]+)"/);
                if (collectorMatch) {
                    metadata.collected_by = collectorMatch[1];
                }

                // Check for type status in various fields
                const typeStatuses = ['holotype', 'paratype', 'isotype', 'neotype', 'lectotype', 'syntype', 'epitype'];
                const featureText = features[0].toLowerCase();
                for (const status of typeStatuses) {
                    if (featureText.includes(status)) {
                        metadata.type_status = status.charAt(0).toUpperCase() + status.slice(1);
                        break;
                    }
                }

                // iNaturalist/MO numbers
                const inatMatch = features[0].match(/inat[^"]*?(\d{5,})/i);
                if (inatMatch) {
                    metadata.inat_mo_number = `iNaturalist #${inatMatch[1]}`;
                }
            }

            // Parse REFERENCE
            const refMatch = record.match(/REFERENCE\s+1[^]*?AUTHORS\s+([^\n]+)/);
            if (refMatch) {
                const authors = refMatch[1].trim().split(',');
                const firstAuthor = authors[0].trim();
                
                // Look for journal/year
                const journalMatch = record.match(/JOURNAL\s+([^\n]+(?:\n\s{12}[^\n]+)*)/);
                if (journalMatch) {
                    const journal = journalMatch[1].replace(/\n\s+/g, ' ').trim();
                    const yearMatch = journal.match(/\((\d{4})\)/);
                    
                    if (yearMatch) {
                        metadata.reference = `${firstAuthor} et al. ${yearMatch[1]}`;
                        metadata.bibliography = `${firstAuthor} et al. (${yearMatch[1]}). ${journal}`;
                    } else {
                        metadata.reference = `${firstAuthor} et al.`;
                        metadata.bibliography = `${firstAuthor} et al. ${journal}`;
                    }
                } else {
                    metadata.reference = `${firstAuthor} et al.`;
                    metadata.bibliography = `${firstAuthor} et al. (unpublished)`;
                }
            }

            return metadata;
        }

        function parseSequenceId(id) {
            const metadata = {
                fasta_id: id,
                species_name: 'Unknown',
                collection_info: '',
                type_status: '',
                genbank_accession: '',
                location: '',
                location_simplified: '',
                isolation_source: '',
                collection_date: '',
                collected_by: '',
                inat_mo_number: '',
                notes: 'Parsed from sequence ID',
                reference: '',
                bibliography: ''
            };

            // Check if it's a GenBank accession
            if (/^[A-Z]+\d+/.test(id)) {
                metadata.genbank_accession = id;
                metadata.notes = 'GenBank accession without record';
            }

            // Parse species name patterns
            if (id.match(/^G\._([a-z]+)/i)) {
                const match = id.match(/^G\._([a-z]+)/i);
                metadata.species_name = `Gymnopilus ${match[1]}`;
            } else if (id.match(/^G_([a-z]+)/i)) {
                const match = id.match(/^G_([a-z]+)/i);
                metadata.species_name = `Gymnopilus ${match[1]}`;
            } else if (id.includes('Gymnopilus')) {
                const match = id.match(/Gymnopilus[_\s]+([a-z]+)/i);
                if (match) {
                    metadata.species_name = `Gymnopilus ${match[1]}`;
                }
            }

            // Check for type status
            const typeStatuses = ['HOLOTYPE', 'ISOTYPE', 'PARATYPE', 'NEOTYPE', 'LECTOTYPE', 'SYNTYPE', 'EPITYPE'];
            for (const status of typeStatuses) {
                if (id.toUpperCase().includes(status)) {
                    metadata.type_status = status.charAt(0) + status.slice(1).toLowerCase();
                    break;
                }
            }

            // Extract collection numbers
            const collectionMatch = id.match(/([A-Z]+[-_]?\d{3,})/);
            if (collectionMatch && !metadata.genbank_accession) {
                metadata.collection_info = collectionMatch[1];
            }

            return metadata;
        }

        function simplifyLocation(location) {
            if (!location) return '';
            
            const parts = location.split(':');
            if (parts.length < 2) return location;
            
            const country = parts[0].trim();
            const region = parts.length > 1 ? parts[1].trim() : '';
            
            if (['USA', 'Canada'].includes(country) && region) {
                const stateProvince = region.split(',')[0].trim();
                return `${country}: ${stateProvince}`;
            }
            
            return country;
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function parseFasta(content) {
            const sequences = [];
            const lines = content.split('\n');
            let currentSeq = null;

            for (const line of lines) {
                if (line.startsWith('>')) {
                    if (currentSeq) {
                        sequences.push(currentSeq);
                    }
                    currentSeq = {
                        id: line.substring(1).trim().split(/\s+/)[0],
                        sequence: ''
                    };
                } else if (currentSeq) {
                    currentSeq.sequence += line.trim();
                }
            }

            if (currentSeq) {
                sequences.push(currentSeq);
            }

            return sequences;
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('logArea').innerHTML = '';
        }

        function updateProgress(current, total, message) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = percent + '%';
            updateStatus(message);
        }

        function updateStatus(message) {
            document.getElementById('statusMessage').textContent = message;
        }

        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function showResults() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            // Calculate statistics
            let stats = {
                total: currentResults.length,
                withGenBank: 0,
                fromLocal: 0,
                typeSpecimens: 0
            };
            
            currentResults.forEach(row => {
                if (row.genbank_accession) stats.withGenBank++;
                if (row.notes && row.notes.includes('local')) stats.fromLocal++;
                if (row.type_status) stats.typeSpecimens++;
            });
            
            // Update stat cards
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statGenBank').textContent = stats.withGenBank;
            document.getElementById('statLocal').textContent = stats.fromLocal;
            document.getElementById('statType').textContent = stats.typeSpecimens;
            
            // Show data preview
            const preview = document.getElementById('dataPreview');
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>FASTA ID</th>
                            <th>Species</th>
                            <th>GenBank</th>
                            <th>Type Status</th>
                            <th>Location</th>
                            <th>Collection</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            currentResults.slice(0, 15).forEach(row => {
                html += `
                    <tr>
                        <td>${row.fasta_id}</td>
                        <td><em>${row.species_name || 'Unknown'}</em></td>
                        <td>${row.genbank_accession || '-'}</td>
                        <td>${row.type_status || '-'}</td>
                        <td>${row.location_simplified || '-'}</td>
                        <td>${row.collection_info || '-'}</td>
                        <td>${row.notes || '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            if (currentResults.length > 15) {
                html += `<p style="margin-top: 10px; color: #666;">Showing 15 of ${currentResults.length} entries</p>`;
            }
            
            preview.innerHTML = html;
        }

        function convertToCSV(data) {
            const headers = [
                'Fasta ID', 'Species Name', 'Species Name Genbank', 
                'Collection/Fungarium Number', 'Type status', 
                'GenBank Accession', 'Location', 'Location simplified',
                'Isolation Source', 'Collection Date', 'Collected By',
                'iNat/MO Number', 'Notes', 'Reference', 'Bibliography'
            ];

            const rows = data.map(row => [
                row.fasta_id,
                row.species_name,
                row.species_name,
                row.collection_info,
                row.type_status,
                row.genbank_accession,
                row.location,
                row.location_simplified,
                row.isolation_source,
                row.collection_date,
                row.collected_by,
                row.inat_mo_number,
                row.notes,
                row.reference,
                row.bibliography
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => 
                    `"${String(cell || '').replace(/"/g, '""')}"`
                ).join(','))
            ].join('\n');

            return csvContent;
        }

        function downloadCSV() {
            const csv = convertToCSV(currentResults);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (currentFileName || 'sequences').replace(/\.(fa|fasta|txt)$/i, '') + '_metadata.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadJSON() {
            const json = JSON.stringify({
                metadata: {
                    filename: currentFileName || 'sequences.fasta',
                    processing_date: new Date().toISOString(),
                    total_entries: currentResults.length,
                    sources: {
                        local_records: Object.keys(localRecords).length,
                        ncbi_records: Object.keys(ncbiRecords).length
                    }
                },
                entries: currentResults
            }, null, 2);
            
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (currentFileName || 'sequences').replace(/\.(fa|fasta|txt)$/i, '') + '_metadata.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearAll() {
            fastaFiles = [];
            genbankFiles = [];
            localFiles = [];
            quickFiles = [];
            currentResults = [];
            currentFileName = '';
            localRecords = {};
            ncbiRecords = {};
            
            // Clear all file lists
            ['fileList', 'genbankList', 'localList', 'quickList'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            
            // Reset buttons
            document.getElementById('processBtn').disabled = true;
            document.getElementById('quickBtn').disabled = true;
            
            // Hide sections
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            
            // Clear file inputs
            ['fileInput', 'genbankInput', 'localInput', 'quickInput'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeEventListeners);
