<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenBank Metadata Extractor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .instructions-box {
            background: #f0f8ff;
            border: 2px solid #4a90e2;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .instructions-box h3 {
            color: #2c5282;
            margin-bottom: 15px;
        }

        .instructions-box ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .instructions-box li {
            margin-bottom: 10px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .file-upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .file-upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .file-upload-area.dragging {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .file-upload-area.green {
            background: #f0fff4;
            border-color: #28a745;
        }

        .file-upload-area.yellow {
            background: #fffef0;
            border-color: #ffc107;
        }

        .file-upload-area input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .file-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            background: #f5f5f5;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item.genbank {
            background: #f0fff4;
            border-left: 4px solid #28a745;
        }

        .file-item.local {
            background: #fffef0;
            border-left: 4px solid #ffc107;
        }

        .file-item button {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .file-item button:hover {
            background: #ff3838;
        }

        .accession-list {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .log-area {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 15px;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            background: #f8f9ff;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .data-table {
            width: 100%;
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th {
            background: #f8f9ff;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #667eea;
            white-space: nowrap;
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #0dcaf0;
            color: #055160;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ GenBank Metadata Extractor</h1>
            <p>Extract metadata from FASTA sequences using GenBank records</p>
        </div>

        <div class="main-card">
            <div class="instructions-box">
                <h3>üìã How to Use This Tool</h3>
                <ol>
                    <li><strong>Upload your FASTA file</strong> - The tool will extract all GenBank accession numbers</li>
                    <li><strong>Copy the accession numbers</strong> that appear below the FASTA upload</li>
                    <li><strong>Go to NCBI:</strong> <a href="https://www.ncbi.nlm.nih.gov/nuccore/" target="_blank">https://www.ncbi.nlm.nih.gov/nuccore/</a></li>
                    <li><strong>Paste the accessions</strong> in the search box (you can search multiple at once)</li>
                    <li><strong>Download GenBank files:</strong> Select "GenBank (full)" format ‚Üí Click "Send to" ‚Üí "File" ‚Üí "Create File"</li>
                    <li><strong>Upload the .gb files</strong> you downloaded in Step 2 below</li>
                    <li><strong>Add any unpublished GenBank files</strong> in Step 3 (optional)</li>
                    <li><strong>Click Process</strong> to extract all metadata and download results as CSV or JSON</li>
                </ol>
            </div>

            <!-- Step 1: FASTA Upload -->
            <div class="section">
                <h2>üìÅ Step 1: Upload FASTA File</h2>
                <div class="file-upload-area" id="fastaArea">
                    <div class="upload-icon">üìÑ</div>
                    <p><strong>Drop FASTA file here or click to browse</strong></p>
                    <p style="color: #888; margin-top: 10px;">Supported: .fasta, .fa, .txt</p>
                    <input type="file" id="fastaInput" accept=".fasta,.fa,.txt" multiple>
                </div>
                <div class="file-list" id="fastaList"></div>
                <div id="accessionDisplay"></div>
            </div>

            <!-- Step 2: GenBank Upload -->
            <div class="section">
                <h2>üìó Step 2: Upload GenBank Files from NCBI</h2>
                <div class="alert alert-success">
                    Downloaded .gb files from NCBI go here
                </div>
                <div class="file-upload-area green" id="genbankArea">
                    <div class="upload-icon" style="color: #28a745;">üìë</div>
                    <p><strong>Drop .gb files here or click to browse</strong></p>
                    <input type="file" id="genbankInput" accept=".gb,.gbk,.txt" multiple>
                </div>
                <div class="file-list" id="genbankList"></div>
            </div>

            <!-- Step 3: Local Files -->
            <div class="section">
                <h2>üìô Step 3: Upload Local/Unpublished GenBank Files (Optional)</h2>
                <div class="alert alert-warning">
                    For sequences not yet in NCBI's public database
                </div>
                <div class="file-upload-area yellow" id="localArea">
                    <div class="upload-icon" style="color: #ffc107;">üìÇ</div>
                    <p><strong>Drop local GenBank files here</strong></p>
                    <input type="file" id="localInput" accept=".gb,.gbk,.txt" multiple>
                </div>
                <div class="file-list" id="localList"></div>
            </div>

            <!-- Process Buttons -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn-primary" id="processBtn" disabled onclick="processFiles()">
                    üöÄ Process Files
                </button>
                <button class="btn-secondary" onclick="clearAll()">
                    üîÑ Clear All
                </button>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <h2>‚öôÔ∏è Processing...</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div id="statusMessage" style="color: #666; margin-top: 10px;"></div>
                <div class="log-area" id="logArea"></div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <h2>üìä Results</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotal">0</div>
                        <div>Total Sequences</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statGenBank" style="color: #28a745;">0</div>
                        <div>With GenBank Data</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statLocal" style="color: #ffc107;">0</div>
                        <div>From Local Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statType" style="color: #dc3545;">0</div>
                        <div>Type Specimens</div>
                    </div>
                </div>
                
                <h3>Data Preview</h3>
                <div class="data-table" id="dataPreview"></div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-primary" onclick="downloadCSV()">
                        üìä Download CSV
                    </button>
                    <button class="btn-primary" onclick="downloadJSON()">
                        üìã Download JSON
                    </button>
                    <button class="btn-secondary" onclick="clearAll()">
                        üîÑ Process New Files
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let fastaFiles = [];
        let genbankFiles = [];
        let localFiles = [];
        let currentResults = [];
        let currentFileName = '';

        // Setup file upload handlers
        document.getElementById('fastaInput').addEventListener('change', function(e) {
            handleFastaFiles(e.target.files);
        });

        document.getElementById('genbankInput').addEventListener('change', function(e) {
            handleGenbankFiles(e.target.files);
        });

        document.getElementById('localInput').addEventListener('change', function(e) {
            handleLocalFiles(e.target.files);
        });

        // Setup drag and drop
        setupDragDrop('fastaArea', handleFastaFiles);
        setupDragDrop('genbankArea', handleGenbankFiles);
        setupDragDrop('localArea', handleLocalFiles);

        function setupDragDrop(areaId, handler) {
            const area = document.getElementById(areaId);
            
            area.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                area.classList.add('dragging');
            });

            area.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                area.classList.remove('dragging');
            });

            area.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                area.classList.remove('dragging');
                handler(e.dataTransfer.files);
            });
        }

        async function handleFastaFiles(files) {
            fastaFiles = Array.from(files).filter(f => f.name.match(/\.(fasta|fa|txt)$/i));
            updateFileList('fastaList', fastaFiles, 'fasta');
            
            // Extract and display accessions
            if (fastaFiles.length > 0) {
                const accessions = await extractAccessions(fastaFiles[0]);
                displayAccessions(accessions);
            }
            
            checkProcessButton();
        }

        function handleGenbankFiles(files) {
            genbankFiles = Array.from(files).filter(f => f.name.match(/\.(gb|gbk|txt)$/i));
            updateFileList('genbankList', genbankFiles, 'genbank');
        }

        function handleLocalFiles(files) {
            localFiles = Array.from(files).filter(f => f.name.match(/\.(gb|gbk|txt)$/i));
            updateFileList('localList', localFiles, 'local');
        }

        async function extractAccessions(file) {
            const content = await readFile(file);
            const sequences = parseFasta(content);
            const accessions = sequences
                .map(seq => seq.id)
                .filter(id => /^[A-Z]+\d+/.test(id));
            return accessions;
        }

        function displayAccessions(accessions) {
            const display = document.getElementById('accessionDisplay');
            if (accessions.length > 0) {
                display.innerHTML = `
                    <div class="alert alert-info" style="margin-top: 15px;">
                        <strong>Found ${accessions.length} GenBank accession(s).</strong> Copy these to search on NCBI:
                    </div>
                    <div class="accession-list">${accessions.join('\n')}</div>
                `;
            } else {
                display.innerHTML = `
                    <div class="alert alert-warning" style="margin-top: 15px;">
                        No GenBank accessions found. These appear to be local sequences.
                    </div>
                `;
            }
        }

        function updateFileList(listId, files, type) {
            const list = document.getElementById(listId);
            list.innerHTML = '';
            
            files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = `file-item ${type}`;
                
                let icon = 'üìÑ';
                if (type === 'genbank') icon = 'üìó';
                if (type === 'local') icon = 'üìô';
                
                item.innerHTML = `
                    <span>${icon} ${file.name} (${formatFileSize(file.size)})</span>
                    <button onclick="removeFile('${type}', ${index})">Remove</button>
                `;
                list.appendChild(item);
            });
        }

        function removeFile(type, index) {
            if (type === 'fasta') {
                fastaFiles.splice(index, 1);
                updateFileList('fastaList', fastaFiles, 'fasta');
                if (fastaFiles.length === 0) {
                    document.getElementById('accessionDisplay').innerHTML = '';
                }
                checkProcessButton();
            } else if (type === 'genbank') {
                genbankFiles.splice(index, 1);
                updateFileList('genbankList', genbankFiles, 'genbank');
            } else if (type === 'local') {
                localFiles.splice(index, 1);
                updateFileList('localList', localFiles, 'local');
            }
        }

        function checkProcessButton() {
            document.getElementById('processBtn').disabled = fastaFiles.length === 0;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function parseFasta(content) {
            const sequences = [];
            const lines = content.split('\n');
            let currentSeq = null;

            for (const line of lines) {
                if (line.startsWith('>')) {
                    if (currentSeq) {
                        sequences.push(currentSeq);
                    }
                    currentSeq = {
                        id: line.substring(1).trim().split(/\s+/)[0],
                        sequence: ''
                    };
                } else if (currentSeq) {
                    currentSeq.sequence += line.trim();
                }
            }

            if (currentSeq) {
                sequences.push(currentSeq);
            }

            return sequences;
        }

        async function processFiles() {
            showProgress();
            log('Starting processing...');
            
            const localRecords = {};
            const ncbiRecords = {};
            currentResults = [];

            // Load local files
            if (localFiles.length > 0) {
                log(`Loading ${localFiles.length} local GenBank file(s)...`);
                for (const file of localFiles) {
                    const content = await readFile(file);
                    parseGenBankFile(content, localRecords, 'local');
                }
                log(`Loaded ${Object.keys(localRecords).length} local records`);
            }

            // Load NCBI files
            if (genbankFiles.length > 0) {
                log(`Loading ${genbankFiles.length} NCBI GenBank file(s)...`);
                for (const file of genbankFiles) {
                    const content = await readFile(file);
                    parseGenBankFile(content, ncbiRecords, 'NCBI');
                }
                log(`Loaded ${Object.keys(ncbiRecords).length} NCBI records`);
            }

            // Process FASTA files
            let totalSeq = 0;
            let processed = 0;

            for (const file of fastaFiles) {
                const content = await readFile(file);
                const sequences = parseFasta(content);
                totalSeq += sequences.length;
            }

            for (const file of fastaFiles) {
                currentFileName = file.name;
                log(`Processing ${file.name}...`);
                
                const content = await readFile(file);
                const sequences = parseFasta(content);

                for (const seq of sequences) {
                    processed++;
                    updateProgress(processed, totalSeq, `Processing ${seq.id}...`);

                    let metadata = findInRecords(seq.id, localRecords, 'local');
                    if (!metadata) {
                        metadata = findInRecords(seq.id, ncbiRecords, 'NCBI');
                    }
                    if (!metadata) {
                        metadata = parseSequenceId(seq.id);
                    }

                    currentResults.push(metadata);
                }
            }

            log('Processing complete!');
            showResults();
        }

        function parseGenBankFile(content, storage, source) {
            const records = content.split(/\/\/\s*\n/);
            
            records.forEach(record => {
                if (!record.trim()) return;
                
                const metadata = parseGenBankRecord(record);
                if (metadata.genbank_accession) {
                    storage[metadata.genbank_accession] = metadata;
                    storage[metadata.genbank_accession.split('.')[0]] = metadata;
                    metadata.notes = `Source: ${source}`;
                }
            });
        }

        function findInRecords(id, records, source) {
            const keys = [id, id.split('.')[0]];
            for (const key of keys) {
                if (records[key]) {
                    const metadata = {...records[key]};
                    metadata.fasta_id = id;
                    log(`Found in ${source}: ${id}`);
                    return metadata;
                }
            }
            return null;
        }

        function parseGenBankRecord(record) {
            const metadata = {
                fasta_id: '',
                species_name: 'Unknown',
                collection_info: '',
                type_status: '',
                genbank_accession: '',
                location: '',
                location_simplified: '',
                isolation_source: '',
                collection_date: '',
                collected_by: '',
                inat_mo_number: '',
                notes: '',
                reference: '',
                bibliography: ''
            };

            const accessionMatch = record.match(/ACCESSION\s+(\S+)/);
            if (accessionMatch) {
                metadata.genbank_accession = accessionMatch[1];
            }

            const organismMatch = record.match(/ORGANISM\s+(.+?)(?:\n|$)/);
            if (organismMatch) {
                const parts = organismMatch[1].trim().split(/\s+/);
                if (parts.length >= 2) {
                    metadata.species_name = `${parts[0]} ${parts[1]}`;
                }
            }

            const locationMatch = record.match(/\/geo_loc_name="([^"]+)"/);
            if (locationMatch) {
                metadata.location = locationMatch[1];
                metadata.location_simplified = simplifyLocation(locationMatch[1]);
            }

            const voucherMatch = record.match(/\/specimen_voucher="([^"]+)"/);
            if (voucherMatch) {
                metadata.collection_info = voucherMatch[1];
            }

            const dateMatch = record.match(/\/collection_date="([^"]+)"/);
            if (dateMatch) {
                metadata.collection_date = dateMatch[1];
            }

            const typeStatuses = ['holotype', 'paratype', 'isotype'];
            for (const status of typeStatuses) {
                if (record.toLowerCase().includes(status)) {
                    metadata.type_status = status.charAt(0).toUpperCase() + status.slice(1);
                    break;
                }
            }

            return metadata;
        }

        function parseSequenceId(id) {
            const metadata = {
                fasta_id: id,
                species_name: 'Unknown',
                collection_info: '',
                type_status: '',
                genbank_accession: /^[A-Z]+\d+/.test(id) ? id : '',
                location: '',
                location_simplified: '',
                isolation_source: '',
                collection_date: '',
                collected_by: '',
                inat_mo_number: '',
                notes: 'Parsed from ID',
                reference: '',
                bibliography: ''
            };

            if (id.match(/G[._]([a-z]+)/i)) {
                const match = id.match(/G[._]([a-z]+)/i);
                metadata.species_name = `Gymnopilus ${match[1]}`;
            }

            return metadata;
        }

        function simplifyLocation(location) {
            if (!location) return '';
            const parts = location.split(':');
            const country = parts[0].trim();
            if (parts.length > 1 && ['USA', 'Canada'].includes(country)) {
                return `${country}: ${parts[1].split(',')[0].trim()}`;
            }
            return country;
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('logArea').innerHTML = '';
        }

        function updateProgress(current, total, message) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = percent + '%';
            document.getElementById('statusMessage').textContent = message;
        }

        function log(message) {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${time}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function showResults() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            let stats = {
                total: currentResults.length,
                withGenBank: 0,
                fromLocal: 0,
                typeSpecimens: 0
            };
            
            currentResults.forEach(row => {
                if (row.genbank_accession) stats.withGenBank++;
                if (row.notes && row.notes.includes('local')) stats.fromLocal++;
                if (row.type_status) stats.typeSpecimens++;
            });
            
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statGenBank').textContent = stats.withGenBank;
            document.getElementById('statLocal').textContent = stats.fromLocal;
            document.getElementById('statType').textContent = stats.typeSpecimens;
            
            const preview = document.getElementById('dataPreview');
            let html = '<table><thead><tr><th>FASTA ID</th><th>Species</th><th>GenBank</th><th>Location</th><th>Source</th></tr></thead><tbody>';
            
            currentResults.slice(0, 10).forEach(row => {
                html += `<tr>
                    <td>${row.fasta_id}</td>
                    <td><em>${row.species_name}</em></td>
                    <td>${row.genbank_accession || '-'}</td>
                    <td>${row.location_simplified || '-'}</td>
                    <td>${row.notes || '-'}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            if (currentResults.length > 10) {
                html += `<p style="margin-top: 10px; color: #666;">Showing 10 of ${currentResults.length} entries</p>`;
            }
            preview.innerHTML = html;
        }

        function downloadCSV() {
            const headers = ['Fasta ID', 'Species Name', 'Species Name Genbank', 'Collection/Fungarium Number', 
                            'Type status', 'GenBank Accession', 'Location', 'Location simplified',
                            'Isolation Source', 'Collection Date', 'Collected By', 'iNat/MO Number', 
                            'Notes', 'Reference', 'Bibliography'];
            
            const rows = currentResults.map(r => [
                r.fasta_id, r.species_name, r.species_name, r.collection_info,
                r.type_status, r.genbank_accession, r.location, r.location_simplified,
                r.isolation_source, r.collection_date, r.collected_by, r.inat_mo_number,
                r.notes, r.reference, r.bibliography
            ]);
            
            const csv = [headers.join(',')]
                .concat(rows.map(row => row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(',')))
                .join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName.replace(/\.(fa|fasta|txt)$/i, '') + '_metadata.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadJSON() {
            const json = JSON.stringify({
                metadata: {
                    filename: currentFileName,
                    processing_date: new Date().toISOString(),
                    total_entries: currentResults.length
                },
                entries: currentResults
            }, null, 2);
            
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName.replace(/\.(fa|fasta|txt)$/i, '') + '_metadata.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAll() {
            fastaFiles = [];
            genbankFiles = [];
            localFiles = [];
            currentResults = [];
            currentFileName = '';
            
            document.getElementById('fastaList').innerHTML = '';
            document.getElementById('genbankList').innerHTML = '';
            document.getElementById('localList').innerHTML = '';
            document.getElementById('accessionDisplay').innerHTML = '';
            document.getElementById('processBtn').disabled = true;
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            
            document.getElementById('fastaInput').value = '';
            document.getElementById('genbankInput').value = '';
            document.getElementById('localInput').value = '';
        }
